{% extends 'blocks.html' %}
{% load toolbox_tags %}

{% block title %}{{ obj }} - {{ block.super }}{% endblock %}

{% block extra-css %}
    {{ block.super }}
    <link rel="stylesheet" href="{{ STATIC_URL }}css/jquery.geocodify-0.2.0.css" type="text/css" charset="utf-8"/>
    <style type="text/css">
        #location-form {
            margin: 0;
            padding: 25px 0 0 0;
            float:right;
        }
        #location-form-input {
            width:315px;
            margin-bottom:0;
        }
        .header h1 { 
            font-size:38px !important;
        }
    </style>
{% endblock %}

{% block extra-js %}
    {{ block.super }}
    <script src="{{ STATIC_URL }}js/leaflet-pip.js" type="text/javascript"></script>
    <script src="{{ STATIC_URL }}js/jquery.geocodify-0.2.0.js" type="text/javascript"></script>
    <script src="http://maps.google.com/maps/api/js?sensor=true"></script>
{% endblock %}

{% block content %}
<div class="row-fluid header">
    <div class="span8">
        <h3 class="kicker"><a href="/">Mapping L.A. Boundaries API</a></h3>
        <h1>{{ obj }}</h1>
    </div>
    <div class="span4">
        <div id="form-wrapper">
            <form id="location-form"></form>
        </div>
    </div>
</div>

<div class="navbar">
  <div class="navbar-inner">
    <ul class="nav">
      <li><a href="/">Finder</a></li>
      <li class="active"><a href="/sets/">Data sets</a></li>
      <li><a href="/about/">About</a></li>
    </ul>
  </div>
</div>

<div class="row-fluid">
    <div class="span12">
        <div id="map-wrapper" style="position:relative;">
            <div id="map-canvas"></div>
            <div id="loader" style="position:absolute; top: 190px; left: 40%; z-index:10000;">
                <center><img src="{{ STATIC_URL }}img/ajax-loader.gif"></center>
            </div>
        </div>
    </div>
</div>

<div id="resultinfo"></div>

<div class="row-fluid">
    <div class="span12 boundaryset">
        <h3>About this data set</h3>
        {% if obj.notes %}<p>{{ obj.notes|safe }}</p>{% endif %}
        <table class="table table-bordered">
            <tbody>
                <tr><th>Last updated</th><td>{{ obj.last_updated }}</td></tr>
                <tr><th>Features</th><td>{{ obj.count }}</td></tr>
                <tr><th>Fields</th><td>{% for f in obj.metadata_fields %}{{ f }}{% if not forloop.last %}, {% endif %}{% endfor %}</td></tr>
                <tr><th>Domain</th><td>{{ obj.domain }}</td></tr>
                <tr><th>Source</th><td>
                    {% if obj.href %}<a href="{{ obj.href }}">{% endif %}
                        {{ obj.authority }}
                    {% if obj.href %}</a>{% endif %}
                </td></tr>
                <tr><th>Schema</th><td>
                    <a href="/1.0/boundary-set/{{ obj.slug }}/">JSON</a>
                </td>
                </tr>
                <tr><th>Bulk downloads</th><td>
                    <a href="/1.0/boundary-set/{{ obj.slug }}/?format=geojson">GeoJSON</a>, 
                    <a href="/1.0/boundary-set/{{ obj.slug }}/?format=kml">KML</a>,
                    <a href="/1.0/boundary-set/{{ obj.slug }}/?format=shp">SHP</a>
                </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block body-bottom %}
<script type="text/jst" id="boundary_template">
    {% include "api/boundaryset_detail.jst" %}
</script>
<script type="text/javascript">
    {% include "api/boundaryset_detail.js" %}
</script>
<script type="text/javascript">
var finder_settings = {{ json_settings|safe }};
var bbox_string = finder_settings.EXAMPLE_PLACE_BBOX.split(',');
var minY = parseFloat(bbox_string[1]);
var maxY = parseFloat(bbox_string[3]);
var minX = parseFloat(bbox_string[0]);
var maxX = parseFloat(bbox_string[2]);
var user_marker;
var selected;
function show_user_marker(lat, lng) {
    var ll = new L.LatLng(lat, lng);
    if (user_marker != null) {
        map.removeLayer(user_marker);
        user_marker = null;
    }
    user_marker = new L.Marker(ll);
    map.addLayer(user_marker);
}
var lat;
var lng;

$('#location-form').geocodify({
    onSelect: function (result) { 
        var location = result.geometry.location;
        lat = Math.round(location.lat()*10000)/10000;
        lng = Math.round(location.lng()*10000)/10000;
        show_user_marker(lat, lng);
        if (map.getZoom() < 13) {
            map.setView([lat, lng], 13);
        } else {
            map.panTo([lat, lng]);
        }
        {% if obj.count < 1000 %}
        var results = leafletPip.pointInLayer([lng, lat], jsonLayer);
        if (results.length) {
            if (results[0] != selected) {
                results[0].fire('click');
                selected = results;
            }
        };
       {% endif %}
    },
    initialText: "Enter an address in Southern California",
    regionBias: 'US',
    viewportBias: new google.maps.LatLngBounds(
        new google.maps.LatLng(minX, minY),
        new google.maps.LatLng(maxX, maxY)
    ),
    filterResults: function(results) {
     var filteredResults =[];
     $.each(results, function(i,val) {
         var location = val.geometry.location;
         if (location.lng() > minY && location.lng() < maxY) {
             if (location.lat() > minX && location.lat() < maxX) {
                 filteredResults.push(val);
            }
         }
     });
     return filteredResults;
    }
});
</script>
{% endblock %}



